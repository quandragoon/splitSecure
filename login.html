<div id="login" class="centerpiece">
<form name="loginform" class="form" method="POST">
<table>
<tr>
   <td>Username:</td>
  <td><input type="text" name="username" size="20"
  autocomplete="no" value=""></td>
</tr>
<tr>
   <td>Password:</td>
  <td colspan=2><input type="password" name="password" size=20 autocomplete="no">
  <input type="button" name="submit" value="Login" onclick="check_log()">
  <input type="button" name="submit" value="Register" onclick="check_reg()"></td>
</tr>
</table>
</form>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
<script>
document.loginform.username.focus();

String.prototype.hashCode = function(){
    var hash = 0, i, char;
    if (this.length == 0) return hash;
    for (i = 0, l = this.length; i < l; i++) {
        char  = this.charCodeAt(i);
        hash  = ((hash<<5)-hash)+char;
        hash |= 0; // Convert to 32bit integer
    }
    return hash;
};

function check_reg()/*function to check userid & password*/
{
  var signature;
  var username = document.loginform.username.value;
  var vals = [];
  var ports = [];
  var db_sent = 0;
  var username_correct = 0;

  var reg_request = $.ajax({
    url: 'https://localhost:8080',
    type: 'POST',
    data: {
    username: document.loginform.username.value,
    submit:'Register'
    },
    success: function (data) {
        signature = data.split('#').slice(1).join('#');
        data = data.split('#')[0];
        if (data != "Username is incorrect") {
          username_correct = 1;
          var pairs = data.split(',');
          var point;
          var pair;
          var A = Math.floor(Math.random()*10000) + 1;
          var B = Math.floor(Math.random()*10000) + 1;
          var C = document.loginform.password.value.hashCode(); // this should be generated from the password
          // var C = CryptoJS.MD5(document.loginform.password.value);
          // console.log(C);
          for (var i = 0; i < pairs.length; ++i){
            pair = pairs[i].split(':');
            ports[i]  = pair[0];
            point = pair[1];
            vals[i]   = A*point*point + B*point + C;
        }
      }
      else
        alert("Username is incorrect");
    },
    error: function (data) {
        console.log(data);
    }
  });

function send_to_db_reg(port, val){
    db_sent++;
    return  $.post('https://localhost:' + port, 
    {username: username,
    value: val.toString(),
    submit: "Register",
    signature: signature}
    ).always(function() {console.log("Sent to " + port)});
  };

  function check_reg_status(){
    if (username_correct){
        $.post('https://localhost:8080',{
            username: username,
            submit: 'CheckReg'
          }, function (result){
            if (result != "R2"){
              if (result == "R1")
                alert("Successfully registered.");
              else if (result == "R0")
                alert("Registration failed.");
            }
          });
    }
  };

  function check_reg_cb(){
    send_to_db_reg(ports[0], vals[0]);
    send_to_db_reg(ports[1], vals[1]);
    send_to_db_reg(ports[2], vals[2]);
    send_to_db_reg(ports[3], vals[3]);
    send_to_db_reg(ports[4], vals[4]);
    while (true){
      if (db_sent == 5){
        setTimeout(check_reg_status, 300);
        break;
      }
    }
  };

  $.when(reg_request).then(check_reg_cb);
}




function check_log()/*function to check userid & password*/
{
  var signature;
  var username = document.loginform.username.value;
  var password = document.loginform.password.value;
  var loginID;
  var db_sent = 0;
  var username_correct = 0;
  var vals = [];
  var ports = [];
	var login_request = $.ajax({
    url: 'https://localhost:8080',
    type: 'POST',
    data: {
		username: username,
		submit:'Login'
		},
    success: function (data) {
      if (data != "Username is incorrect"){
        username_correct = 1;
        loginID = data.split('#')[0];
        signature = data.split('#').slice(2).join('#');
        data = data.split('#')[1];
        var pairs = data.split(',');
        var point;
        var pair;
        var a = Math.floor(Math.random()*10000) + 1;
        var b = Math.floor(Math.random()*10000) + 1;
        var c = password.hashCode(); // this should be generated from the password
        // var c = CryptoJS.MD5(password);
        // console.log(c);
        for (var i = 0; i < pairs.length; ++i){
          pair = pairs[i].split(':');
          ports[i]  = pair[0];
          point = pair[1];
          vals[i] = a*point*point + b*point + c;
        }
      }
    },
    error: function (data) {
        console.log(data);
        alert("Failed to login");
    }
	});

  function send_to_db(port, val){
    db_sent++;
    return  $.post('https://localhost:' + port, 
    {username: username,
    loginID: loginID,
    value: val.toString(),
    submit: "Login",
    signature: signature}
    ).always(function() {console.log("Sent to " + port)});
  };

  function check_auth(){
    if (username_correct){
        $.post('https://localhost:8080',{
            username: username,
            loginID: loginID,
            submit: 'Auth'
          }, function (result){
            if (result != "L2"){
              if (result == "L1")
                alert("Successfully logged in.");
              else if (result == "L0")
                alert("Incorrect password.");
            }
          });
    }
  };

  function check_auth_cb(){
    send_to_db(ports[0], vals[0]);
    send_to_db(ports[1], vals[1]);
    send_to_db(ports[2], vals[2]);
    while (true){
      if (db_sent == 3){
        setTimeout(check_auth, 300);
        break;
      }
    }
  };

  $.when(login_request).then(check_auth_cb);
}

</script>

